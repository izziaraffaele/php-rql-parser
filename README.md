php-rql-parser - A PHP RQL Parsing Library
==============

[![Build Status](https://travis-ci.org/libgraviton/php-rql-parser.svg?branch=develop)](https://travis-ci.org/libgraviton/php-rql-parser) [![Scrutinizer Code Quality](https://scrutinizer-ci.com/g/libgraviton/php-rql-parser/badges/quality-score.png?b=develop)](https://scrutinizer-ci.com/g/libgraviton/php-rql-parser/?branch=develop) [![Code Coverage](https://scrutinizer-ci.com/g/libgraviton/php-rql-parser/badges/coverage.png?b=develop)](https://scrutinizer-ci.com/g/libgraviton/php-rql-parser/?branch=develop) [![Latest Stable Version](https://poser.pugx.org/graviton/php-rql-parser/v/stable.svg)](https://packagist.org/packages/graviton/php-rql-parser) [![Total Downloads](https://poser.pugx.org/graviton/php-rql-parser/downloads.svg)](https://packagist.org/packages/graviton/php-rql-parser) [![Latest Unstable Version](https://poser.pugx.org/graviton/php-rql-parser/v/unstable.svg)](https://packagist.org/packages/graviton/php-rql-parser) [![License](https://poser.pugx.org/graviton/php-rql-parser/license.svg)](https://packagist.org/packages/graviton/php-rql-parser)


This is a small [RQL](https://github.com/persvr/rql/) (Resource Query Language) parsing library written in PHP. It uses [doctrine/lexer](https://github.com/doctrine/lexer) and
a doctrine inspired parser to create and abstract syntax tree of the query. While it ships with a [doctrine/mongo-odm](https://github.com/doctrine/mongodb-odm) querybuilding
visitor, writing you own should not be hard.

This package adheres to [SemVer](http://semver.org/spec/v2.0.0.html) versioning. It will be considered stable after reaching 2.x since the initial 1.x release is
considered rather buggy.

It uses a github version of [git-flow](http://nvie.com/posts/a-successful-git-branching-model/) in which new features and bugfixes must be merged to develop
using a github pull request. It uses the standard git-flow naming conventions with the addition of a 'v' prefix to version tags.

This library is under heavy development. If you need an RQL parser for PHP please consider pitching in by contributing to this parser.

## Overview

This library consists of the following parts:

* a lexer and parser for creating an abstract syntax tree from rql code
* a visitor implementation for using a mongodb-odm querybuilder with the abstract syntax tree
* unit and acceptance tests for all of this

## Current state

This supports a limited subset of RQL. Currently it does not support any sugar syntax in queries.

* ``eq(name,foo)`` 
* ``ne(name,foo)``
* ``lt(count,1)``
* ``gt(count,1)``
* ``lte(count,1)``
* ``gte(count,1)``
* ``sort(+name,-count)`` and ``sort(name,asc)``
* ``limit(limit,[skip])``
* ``in(name,[foo,bar])``
* ``out(name,[foo,bar])``
* ``and(<query>,<query>)``
* ``or(<query>,<query>)``

Please have a look at [``LexerTest``](test/LexerTest.php) and [``ParserTest``](test/ParserTest.php) for more details.

The mongo-odm visitor supports the operators implemented in the parser. Look at [``MongoOdmTest``](test/MongoOdmTest.php) to see what is supported. There are mostly
likely remaining edge cases that the visitor does not solve adequately yet.

## Installation

Install it using [composer](https://getcomposer.org/).

```bash
composer require graviton/php-rql-parser
```

## Usage

```php
<?php

require 'vendor/autoload.php';

$rql = 'or(eq(name,foo),eq(name,bar))';

// parse some Resource Query Language 
$parser = \Graviton\Rql\Parser::createParser($rql);

// get abstract syntax tree and do something
$ast = $parser->getAST();
// ...

// apply AST to  a doctrine/mongo-odm querybuilder and get a query
/** @var \Doctrine\ODM\MongoDB\Query\Builder $builder */
$visitor = new \Graviton\Rql\Visitor\MongoOdm($builder);
$visitor->accept($ast);
$query = $visitor->getBuilder()->getQuery();
```

## Development

We welcome contributions on the develop branch.

To interface this with a backend (like MongoDB or PHP ActiveRecord) you need to
implement a visitor. This visitor is then responsible for walking the abstract
syntax tree generated by the parser.

### Adding a Visitor

Please look at the [``src/Visitor/``](src/Visitor/) for examples of how to traverse the abstract syntax
tree if you need to implement something based off the parser.

Your visitor will get passed the AST and is responsible for traversing it.

```php
<?php

use Graviton\Rql\Visitor\VistorInterface;
use Graviton\Rql\AST;

class DemoVisitor implements VisitorInterface
{
    public function visit(AST\OperationInterface $operation)
    {
        // look at $operations class and or interfaces and apply things
        // ...
        
        // check to see if we need to iterate
        if ($operation instanceof AST\QueryOperationInterface) {
            foreach ($operation->getQueries() as $query) {
                $this->visit($query);
            }
        }
    }
}

```

### The AST

The AST that your visitor needs to traverse is built from the class tree in [``src/AST``](src/AST).

* ``AST\AbstractOperation``
  * ``AST\AbstractPropertyOperation``
    * ``AST\EqOperation``
    * ``AST\NeOperation``
    * ``AST\LtOperation``
    * ``AST\GtOperation``
    * ``AST\LteOperation``
    * ``AST\GteOperation``
    * ``AST\LikeOperation``
  * ``AST\AbstractQueryOperation``
    * ``AST\QueryOperation``
    * ``AST\AndOperation``
    * ``AST\OrOperation``
  * ``AST\AbstractArrayOperation``
    * ``AST\InOperation``
    * ``AST\OutOperation``
  * ``AST\LimitOperation``
  * ``AST\SortOperation``

The grouping of the operations is mostly based on the similarity of their call
signatures. This is exposed through the following interfaces that you may use
for dispatching in your visitor.

* [``AST\PropertyOperationInterface``](src/AST/PropertyOperationInterface.php)
* [``AST\QueryOperationInterface``](src/AST/QueryOperationInterface.php)
* [``AST\ArrayOperationInterface``](src/AST/ArrayOperationInterface.php)
* [``AST\LimitOperationInterface``](src/AST/LimitOperationInterface.php)
* [``AST\SortOperationInterface``](src/AST/SortOperationInterface.php)
